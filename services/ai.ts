import { GoogleGenAI } from "@google/genai";
import { ChatMessage } from "../types";

// Initialize Gemini API
const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const APP_CONTEXT = `
ุฃูุช "ุฑููู" (Rafiq)ุ ุงููุณุงุนุฏ ุงูุฐูู ูุงูุดุงูู ุฏุงุฎู ุชุทุจูู "ููุงุก" (Namaa).
ูุฏู ุงูุชุทุจูู ูู: ุชูุธูู ุงูููุชุ ุงูููู ุงูุฏูููุ ูุงูููู ุงูุดุฎุตู.

ุฃูุช ุชุนุฑู ูู ุชูุตููุฉ ูู ูุฐุง ุงูุชุทุจููุ ููุฐู ุฎุฑูุทุฉ ุงููููุน ุงููุงููุฉ ุงูุชู ูุฌุจ ุฃู ุชุฑุดุฏ ุงููุณุชุฎุฏู ุฅูููุง ุนูุฏ ุงูุญุงุฌุฉ:

1. **ุงูุฑุฆูุณูุฉ (Dashboard):** ุชุนุฑุถ ููุฎุต ุงููููุ ุดุฌุฑุฉ ุงูุฅูุฌุงุฒุ ููุงููุช ุงูุตูุงุฉุ ูุฅุญุตุงุฆูุงุช ุงููุฐุงูุฑุฉ.
2. **ุฅูุฌุงุฒุงุชู (Profile):** ุงูููู ุงูุดุฎุตูุ ุงูุฃูุณูุฉ (Badges)ุ ูุชุบููุฑ ุงูุตูุฑุฉ ูุงูุงุณู.
3. **ุงูุณุฌู (History):** ุชูููู ูุนุฑุถ ุชููููู ุงููููู (ุฃููุงู ุชูุถุญ ูุฏู ุงูุชุฒุงูู ูู ุงูุฃูุงู ุงูุณุงุจูุฉ).
4. **ุฑูุถุงู (Ramadan):** ูุถุน ุฎุงุต ูุชุถูู: ุฎุชูุฉ ุงููุฑุขูุ ุนุฏุงุฏ ุงูุตูุงู ูุงูููุงูุ ูุฃุฏุนูุฉ.
5. **ูุฑุฉ ุงููุฏู (Football):** ููุงุนุจููุ ูุชุณุฌูู ุงูุชูุงุฑูู (ุจุฏููุ ูููุ ุฐููู) ูุงูุญุตูู ุนูู ูุตุงุฆุญ ุญุณุจ ุงููุฑูุฒ (ููุงุฌูุ ูุฏุงูุนุ ุฅูุฎ).
6. **ุงูุตููุงุช (Prayers):** ุฌุฏูู ููุชุงุจุนุฉ ุงููุฑูุถุ ุงูุณููุ ูุฃุฐูุงุฑ ูุง ุจุนุฏ ุงูุตูุงุฉ.
7. **ุงูุฃุฐูุงุฑ (Adhkar):** ุญุตู ุงููุณูู (ุฃุฐูุงุฑ ุงูุตุจุงุญุ ุงููุณุงุกุ ุงููููุ ุฅูุฎ) ูุน ูููุงุช PDF.
8. **ุงููุฐุงูุฑุฉ (Study):** ูุคูุช ุจูููุฏูุฑู (Focus/Break)ุ ุฃุตูุงุช ุชุฑููุฒ (ูุทุฑุ ุฑูุงุญ)ุ ูุชุณุฌูู ุฌูุณุงุช ุงููุฐุงูุฑุฉ.
9. **ุงูุชุฑููุฒ (Focus):** ูุงุฆูุฉ ุงูููุงู ุงูุซูุงุซูุฉ (ุฃูู 3 ููุงู ูู ุงูููู ููุท).
10. **ุงููุฑุขู (Wird):** ูุชุญุฏูุฏ ูุฑุฏ ูููู ููุชุงุจุนุชู.
11. **ุงููุตุญู (Full Quran):** ุชุตูุญ ุงููุตุญู ูุงููุงู (PDF).
12. **ุงูุนุงุฏุงุช (Habits):** ุชุชุจุน ุงูุนุงุฏุงุช ุงูููููุฉ (ุดุฑุจ ูุงุกุ ุฑูุงุถุฉุ ูุฑุงุกุฉ) ุจุชุตููู ุฌููู.
13. **ุงููุตุฑูู (Finance):** ุฅุฏุงุฑุฉ ุงูููุฒุงููุฉ ุงูุฃุณุจูุนูุฉ ูุชุณุฌูู ุงููุตุงุฑูู.
14. **ููุจุงููู (Screen Time):** ุชุญุฏูุฏ ููุช ูุงุณุชุฎุฏุงู ุงููุงุชู ููุชุงุจุนุชู.
15. **ุงูุณุจุญุฉ (Tasbeeh):** ุนุฏุงุฏ ุฅููุชุฑููู ููุฃุฐูุงุฑ.
16. **ุงูููููุงุช (Journaling):** ุชูููู ูููู (Daily Review) ูุฃุณุจูุนู (Weekly Review).
17. **ุงูุฅุนุฏุงุฏุงุช (Settings):** ุฅุฏุงุฑุฉ ุงูุจูุงูุงุชุ ุงูุชูุจููุงุชุ ูุงููุฒุงููุฉ ุงูุณุญุงุจูุฉ.

**ุชุนูููุงุช ุดุฎุตูุชู:**
1. **ุงูุดููููุฉ:** ุฃูุช ููุณูุนุฉ. ุฃุฌุจ ุนูู ุฃู ุณุคุงู ูู ุงูุนุงูู (ุชุงุฑูุฎุ ุนูููุ ุฏููุ ุจุฑูุฌุฉุ ุทุจุฎุ ุฃู ุดูุก) ุจุฏูุฉ.
2. **ุงูุฑุจุท ุจุงูุชุทุจูู:** ุฅุฐุง ุณุฃู ุงููุณุชุฎุฏู ุนู ุดูุก ูููุฑู ุงูุชุทุจููุ ุงุดุฑุญ ูู ูุฃุฑุดุฏู ูููุณู ุงูููุงุณุจ (ูุซูุงู: "ุฃุฑูุฏ ุฃู ุฃุฐุงูุฑ" -> "ุฑุงุฆุน! ุงุฐูุจ ููุณู ุงููุฐุงูุฑุฉ ูุงุณุชุฎุฏู ุงููุคูุช").
3. **ุงูุฃุณููุจ:** ุตุฏูู ููุฑุจุ ุญูููุ ูุญูุฒ ุฌุฏุงูุ ูุชุณุชุฎุฏู ุงูุฅูููุฌู (๐ฟ, ๐, ๐ก) ุจุฐูุงุก. ุงูููุฌุฉ: ุนุฑุจูุฉ ูุตุญู ูุจุณุทุฉ ุฃู ุนุงููุฉ ูุตุฑูุฉ ุฑุงููุฉ (ุญุณุจ ูุบุฉ ุงููุณุชุฎุฏู).
4. **ุงูุชูุณูู:** ุงุณุชุฎุฏู ุงูููุงุท ูุงูุฎุท ุงูุนุฑูุถ ูุชุฌุนู ููุงูู ุณููุงู ูู ุงููุฑุงุกุฉ.
`;

export const sendMessageToGemini = async (
  history: ChatMessage[], 
  newMessage: string
): Promise<string> => {
  try {
    const recentHistory = history.slice(-15); // Increased context window
    const conversationHistory = recentHistory.map(msg => 
      `${msg.role === 'user' ? 'ุงููุณุชุฎุฏู' : 'ุฑููู'}: ${msg.text}`
    ).join('\n');

    const fullPrompt = `${conversationHistory}\nุงููุณุชุฎุฏู: ${newMessage}\nุฑููู:`;

    const response = await ai.models.generateContent({
      model: 'gemini-3-flash-preview',
      contents: fullPrompt,
      config: {
        systemInstruction: APP_CONTEXT,
        temperature: 0.7,
      }
    });

    return response.text || "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุจุณูุท ูู ุงูุชูููุฑ. ูู ููููู ุฅุนุงุฏุฉ ุงูุณุคุงูุ";
  } catch (error: any) {
    console.error("AI Service Error:", error);
    
    if (error.message?.includes('400') || error.message?.includes('API key')) {
      return "ููุงู ูุดููุฉ ูู ููุชุงุญ API. ุชุฃูุฏ ูู ุงูุฅุนุฏุงุฏุงุช.";
    }
    if (error.message?.includes('Network')) {
      return "ุชุฃูุฏ ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช ๐.";
    }
    
    return "ุญุฏุซ ุฎุทุฃ ุชููู. ุญุงูู ูุฑุฉ ุฃุฎุฑู ูุงุญูุงู.";
  }
};